trigger:
- main  # Trigger on commits to the main branch

variables:
- group: letter-backend-variable-group  # Reference your variable group
- name: containerRegistry
  value: "letterregistry.azurecr.io"  # Replace with your ACR name
- name: imageTag
  value: "$(Build.BuildId)"  # Unique tag for each build

stages:
- stage: BuildAndPush
  displayName: Build and Push Backend Image
  jobs:
  - job: BuildAndPushImage
    displayName: Build and Push Docker Image to ACR
    pool:
      name: EC2-Agents
    steps:
    - task: DockerInstaller@0
      displayName: Install Docker

    - script: |
        docker build -t letter_backend ./Backend
        docker tag letter_backend $(containerRegistry)/letter_backend:$(imageTag)
        echo $(DOCKER_PASSWORD) | docker login $(containerRegistry) -u $(DOCKER_USERNAME) --password-stdin
        docker push $(containerRegistry)/letter_backend:$(imageTag)
      displayName: Build and Push Docker Image to ACR